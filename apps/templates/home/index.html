{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

{% block stylesheets %}
<style>
    .info-icon { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .info-icon.icon-primary { background: rgba(29,140,248,0.2); color: #1d8cf8; }
    .info-icon.icon-success { background: rgba(0,242,195,0.2); color: #00f2c3; }
    .info-icon.icon-warning { background: rgba(255,141,114,0.2); color: #ff8d72; }
    .info-icon.icon-info { background: rgba(29,140,248,0.2); color: #1d8cf8; }
    .info-icon.icon-danger { background: rgba(253,93,147,0.2); color: #fd5d93; }
    .stat-numbers h3 { margin-bottom: 0; font-size: 1.25rem; font-weight: 600; }
    .stat-numbers .card-category { margin-bottom: 2px; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .top-pick-card { transition: transform 0.2s ease; border-left: 3px solid transparent; }
    .top-pick-card:hover { transform: translateY(-3px); }
    .badge-pill { font-size: 0.7rem; padding: 0.35em 0.65em; font-weight: 500; }
    @media (max-width: 768px) {
        .table .hide-mobile { display: none; }
        .table td, .table th { font-size: 0.75rem; padding: 0.4rem; }
    }
</style>
{% endblock stylesheets %}

{% block content %}

    <div class="content">
        <!-- Stat Cards Row -->
        <div class="row">
            <div class="col-lg col-md-4 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center icon-primary">
                                    <i class="tim-icons icon-chart-bar-32"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">Predictions</p>
                                    <h3 class="card-title">{{ total_predictions }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-4 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center icon-success">
                                    <i class="tim-icons icon-trophy"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">Value Bets</p>
                                    <h3 class="card-title">{{ positive_value_count|default:"0" }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-4 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center icon-warning">
                                    <i class="tim-icons icon-coins"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">Avg Value</p>
                                    <h3 class="card-title">{{ avg_value|default:"0" }}%</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-4 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center icon-info">
                                    <i class="tim-icons icon-planet"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">Top League</p>
                                    <h3 class="card-title" style="font-size: 0.85rem;">{{ top_league|default:"N/A" }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg col-md-4 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center icon-danger">
                                    <i class="tim-icons icon-refresh-02" id="refresh-icon"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">Updated</p>
                                    <h3 class="card-title" style="font-size: 0.75rem;">{{ last_updated }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-right pt-0">
                        <button id="refresh-btn" class="btn btn-sm btn-link text-info p-0" onclick="refreshPredictions()" {% if refresh_running %}disabled{% endif %}>
                            <span id="refresh-text">{% if refresh_running %}Refreshing...{% else %}Refresh{% endif %}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- O/U Stats Row -->
        {% if ou_value_count is not None %}
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center" style="background: rgba(186,84,245,0.2); color: #ba54f5;">
                                    <i class="tim-icons icon-chart-bar-32"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">O/U Value Bets</p>
                                    <h3 class="card-title">{{ ou_value_count }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center" style="background: rgba(186,84,245,0.2); color: #ba54f5;">
                                    <i class="tim-icons icon-money-coins"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">O/U Avg Value</p>
                                    <h3 class="card-title">{{ ou_avg_value }}%</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center" style="background: rgba(0,242,195,0.2); color: #00f2c3;">
                                    <i class="tim-icons icon-minimal-up"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">Over Picks</p>
                                    <h3 class="card-title">{{ ou_over_count }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 col-sm-6">
                <div class="card card-stats">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-5 col-md-4">
                                <div class="info-icon text-center" style="background: rgba(253,93,147,0.2); color: #fd5d93;">
                                    <i class="tim-icons icon-minimal-down"></i>
                                </div>
                            </div>
                            <div class="col-7 col-md-8">
                                <div class="stat-numbers text-right">
                                    <p class="card-category">Under Picks</p>
                                    <h3 class="card-title">{{ ou_under_count }}</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Charts Row -->
        {% if pred_counts_json %}
        <div class="row">
            <div class="col-lg-4 col-md-6">
                <div class="card card-chart">
                    <div class="card-header">
                        <h5 class="card-category">Prediction Split</h5>
                        <h4 class="card-title">Home / Draw / Away</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="height: 220px;">
                            <canvas id="predBreakdownChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6">
                <div class="card card-chart">
                    <div class="card-header">
                        <h5 class="card-category">Coverage</h5>
                        <h4 class="card-title">Predictions by League</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="height: 220px;">
                            <canvas id="leagueCountChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="card card-chart">
                    <div class="card-header">
                        <h5 class="card-category">Value Analysis</h5>
                        <h4 class="card-title">Avg Value by League</h4>
                    </div>
                    <div class="card-body">
                        <div class="chart-area" style="height: 220px;">
                            <canvas id="avgValueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Top Picks Section -->
        {% if top_picks %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title"><i class="tim-icons icon-trophy text-warning"></i> Top Picks</h4>
                        <p class="card-category">Highest value predictions</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for pick in top_picks %}
                            <div class="col-lg col-md-4 col-sm-6 mb-3">
                                <div class="card mb-0 top-pick-card" style="background: rgba(255,255,255,0.04); border-left-color: {% if pick.Max_Value_Raw > 0.15 %}#00f2c3{% elif pick.Max_Value_Raw > 0 %}#1d8cf8{% else %}#fd5d93{% endif %};">
                                    <div class="card-body p-3">
                                        <p class="card-category mb-1" style="font-size: 0.7rem;">{{ pick.LeagueName|default:pick.Div }} &middot; {{ pick.Date }}</p>
                                        <h5 class="card-title mb-2" style="font-size: 0.9rem; line-height: 1.3;">
                                            {{ pick.HomeTeam }} <span class="text-muted">vs</span> {{ pick.AwayTeam }}
                                        </h5>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge badge-pill badge-{% if pick.Pred_FTR == 'H' %}primary{% elif pick.Pred_FTR == 'D' %}warning{% else %}info{% endif %}">
                                                {% if pick.Pred_FTR == 'H' %}HOME{% elif pick.Pred_FTR == 'D' %}DRAW{% else %}AWAY{% endif %}
                                            </span>
                                            <span class="badge badge-pill badge-{% if pick.Max_Value_Raw > 0 %}success{% else %}danger{% endif %}" style="font-size: 0.8rem;">
                                                {{ pick.Max_Value }}
                                            </span>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between" style="font-size: 0.7rem;">
                                            <span class="text-muted">{{ pick.Max_Value_Result }}: <strong class="text-white">{{ pick.Best_Odds|default:"-" }}</strong></span>
                                            <span class="text-muted">H {{ pick.Odds_H|default:"-" }} &middot; D {{ pick.Odds_D|default:"-" }} &middot; A {{ pick.Odds_A|default:"-" }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Confidence Picks Section -->
        {% if confidence_picks %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title"><i class="tim-icons icon-check-2" style="color: #ba54f5;"></i> Confidence Picks</h4>
                        <p class="card-category">6-signal composite: value + decisive probability + model agreement + predictable teams/league + sensible odds ({{ confidence_pick_count }} qualifying)</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for pick in confidence_picks %}
                            <div class="col-lg col-md-4 col-sm-6 mb-3">
                                <div class="card mb-0 top-pick-card" style="background: rgba(255,255,255,0.04); border-left-color: #ba54f5;">
                                    <div class="card-body p-3">
                                        <p class="card-category mb-1" style="font-size: 0.7rem;">{{ pick.LeagueName|default:pick.Div }} &middot; {{ pick.Date }}</p>
                                        <h5 class="card-title mb-2" style="font-size: 0.9rem; line-height: 1.3;">
                                            {{ pick.HomeTeam }} <span class="text-muted">vs</span> {{ pick.AwayTeam }}
                                        </h5>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge badge-pill badge-{% if pick.Pred_FTR == 'H' %}primary{% elif pick.Pred_FTR == 'D' %}warning{% else %}info{% endif %}">
                                                {% if pick.Pred_FTR == 'H' %}HOME{% elif pick.Pred_FTR == 'D' %}DRAW{% else %}AWAY{% endif %}
                                            </span>
                                            <span class="badge badge-pill badge-success" style="font-size: 0.8rem;">
                                                {{ pick.Max_Value }}
                                            </span>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between" style="font-size: 0.7rem;">
                                            <span class="text-muted">{{ pick.Max_Value_Result }}: <strong class="text-white">{{ pick.Best_Odds|default:"-" }}</strong></span>
                                            <span class="text-muted">H {{ pick.Odds_H|default:"-" }} &middot; D {{ pick.Odds_D|default:"-" }} &middot; A {{ pick.Odds_A|default:"-" }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- O/U Top Picks Section -->
        {% if ou_top_picks %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title"><i class="tim-icons icon-minimal-up" style="color: #00f2c3;"></i><i class="tim-icons icon-minimal-down" style="color: #fd5d93;"></i> Over/Under Top Picks</h4>
                        <p class="card-category">Highest value Over/Under 2.5 predictions</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for pick in ou_top_picks %}
                            <div class="col-lg col-md-4 col-sm-6 mb-3">
                                <div class="card mb-0 top-pick-card" style="background: rgba(255,255,255,0.04); border-left-color: {% if pick.OU_Best_Bet == 'Over 2.5' %}#00f2c3{% else %}#fd5d93{% endif %};">
                                    <div class="card-body p-3">
                                        <p class="card-category mb-1" style="font-size: 0.7rem;">{{ pick.LeagueName|default:pick.Div }} &middot; {{ pick.Date }}</p>
                                        <h5 class="card-title mb-2" style="font-size: 0.9rem; line-height: 1.3;">
                                            {{ pick.HomeTeam }} <span class="text-muted">vs</span> {{ pick.AwayTeam }}
                                        </h5>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge badge-pill {% if pick.OU_Best_Bet == 'Over 2.5' %}badge-success{% else %}badge-danger{% endif %}">
                                                {{ pick.OU_Best_Bet|default:"-" }}
                                            </span>
                                            <span class="badge badge-pill badge-success" style="font-size: 0.8rem;">
                                                {{ pick.OU_Max_Value }}
                                            </span>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between" style="font-size: 0.7rem;">
                                            <span class="text-muted">Odds: <strong class="text-white">{{ pick.OU_Best_Odds|default:"-" }}</strong></span>
                                            <span class="text-muted">O {{ pick.Over25|default:"-" }} &middot; U {{ pick.Under25|default:"-" }}</span>
                                        </div>
                                        <div class="mt-1" style="font-size: 0.65rem;">
                                            <span class="text-muted">Pred Goals: {{ pick.Pred_FTHG|default:"-" }} - {{ pick.Pred_FTAG|default:"-" }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- O/U Confidence Picks Section -->
        {% if ou_confidence_picks %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title"><i class="tim-icons icon-check-2" style="color: #ba54f5;"></i> O/U Confidence Picks</h4>
                        <p class="card-category">Composite filter: value + decisive probability + goals alignment + sensible odds + league data ({{ ou_confidence_pick_count }} qualifying)</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for pick in ou_confidence_picks %}
                            <div class="col-lg col-md-4 col-sm-6 mb-3">
                                <div class="card mb-0 top-pick-card" style="background: rgba(255,255,255,0.04); border-left-color: #ba54f5;">
                                    <div class="card-body p-3">
                                        <p class="card-category mb-1" style="font-size: 0.7rem;">{{ pick.LeagueName|default:pick.Div }} &middot; {{ pick.Date }}</p>
                                        <h5 class="card-title mb-2" style="font-size: 0.9rem; line-height: 1.3;">
                                            {{ pick.HomeTeam }} <span class="text-muted">vs</span> {{ pick.AwayTeam }}
                                        </h5>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge badge-pill {% if pick.OU_Best_Bet == 'Over 2.5' %}badge-success{% else %}badge-danger{% endif %}">
                                                {{ pick.OU_Best_Bet|default:"-" }}
                                            </span>
                                            <span class="badge badge-pill badge-success" style="font-size: 0.8rem;">
                                                {{ pick.OU_Max_Value }}
                                            </span>
                                        </div>
                                        <div class="mt-2 d-flex justify-content-between" style="font-size: 0.7rem;">
                                            <span class="text-muted">Odds: <strong class="text-white">{{ pick.OU_Best_Odds|default:"-" }}</strong></span>
                                            <span class="text-muted">O {{ pick.Over25|default:"-" }} &middot; U {{ pick.Under25|default:"-" }}</span>
                                        </div>
                                        <div class="mt-1" style="font-size: 0.65rem;">
                                            <span class="text-muted">Pred Goals: {{ pick.Pred_FTHG|default:"-" }} - {{ pick.Pred_FTAG|default:"-" }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recent Predictions Table -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Recent Predictions</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table tablesorter">
                                <thead class="text-primary">
                                    <tr>
                                        <th>League</th>
                                        <th>Date</th>
                                        <th class="hide-mobile">Time</th>
                                        <th>Home Team</th>
                                        <th>Away Team</th>
                                        <th>Home %</th>
                                        <th class="hide-mobile">Draw %</th>
                                        <th>Away %</th>
                                        <th>Prediction</th>
                                        <th class="hide-mobile">BTTS</th>
                                        <th class="hide-mobile">O2.5</th>
                                        <th>Value</th>
                                        <th class="hide-mobile">Best Bet</th>
                                        <th>Odds</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in recent_predictions %}
                                        <tr {% if item.Max_Value_Raw > 0.15 %}style="background: rgba(0, 242, 195, 0.06);"{% endif %}>
                                            <td>{{ item.LeagueName|default:item.Div }}</td>
                                            <td>{{ item.Date }}</td>
                                            <td class="hide-mobile">{{ item.Time }}</td>
                                            <td>{{ item.HomeTeam }}</td>
                                            <td>{{ item.AwayTeam }}</td>
                                            <td>{{ item.HWin }} <small class="text-muted">({{ item.Odds_H|default:"-" }})</small></td>
                                            <td class="hide-mobile">{{ item.Draw }} <small class="text-muted">({{ item.Odds_D|default:"-" }})</small></td>
                                            <td>{{ item.AWin }} <small class="text-muted">({{ item.Odds_A|default:"-" }})</small></td>
                                            <td>
                                                <span class="badge badge-pill badge-{% if item.Pred_FTR == 'H' %}primary{% elif item.Pred_FTR == 'D' %}warning{% else %}info{% endif %}">
                                                    {% if item.Pred_FTR == 'H' %}HOME{% elif item.Pred_FTR == 'D' %}DRAW{% else %}AWAY{% endif %}
                                                </span>
                                            </td>
                                            <td class="hide-mobile">{{ item.BTTS_Yes|default:"-" }}</td>
                                            <td class="hide-mobile">{{ item.Over25|default:"-" }}</td>
                                            <td class="{% if item.Max_Value_Raw > 0 %}text-success{% else %}text-danger{% endif %}" style="font-weight: 600;">
                                                {{ item.Max_Value }}
                                            </td>
                                            <td class="hide-mobile">
                                                <span class="badge badge-pill" style="background: rgba(255,255,255,0.1); font-size: 0.68rem;">
                                                    {{ item.Max_Value_Result }}
                                                </span>
                                            </td>
                                            <td class="text-muted">{{ item.Best_Odds|default:"-" }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="14" class="text-center">No predictions available. Click "Refresh" to generate.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if total_predictions > 10 %}
                        <div class="text-right mt-2">
                            <a href="/tables.html" class="btn btn-primary btn-sm">View all {{ total_predictions }} predictions &rarr;</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock content %}

{% block javascripts %}
<script>
function refreshPredictions() {
    var btn = document.getElementById('refresh-btn');
    var icon = document.getElementById('refresh-icon');
    var text = document.getElementById('refresh-text');

    btn.disabled = true;
    icon.style.animation = 'spin 1s linear infinite';
    text.textContent = 'Refreshing...';

    fetch('/api/refresh/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.status === 'started' || data.status === 'already_running') {
            pollStatus();
        }
    })
    .catch(function(err) {
        btn.disabled = false;
        icon.style.animation = '';
        text.textContent = 'Refresh';
        alert('Failed to start refresh: ' + err);
    });
}

function pollStatus() {
    var interval = setInterval(function() {
        fetch('/api/refresh/status/')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (!data.running) {
                clearInterval(interval);
                if (data.error) {
                    alert('Refresh failed: ' + data.error);
                    var btn = document.getElementById('refresh-btn');
                    btn.disabled = false;
                    document.getElementById('refresh-icon').style.animation = '';
                    document.getElementById('refresh-text').textContent = 'Refresh';
                } else {
                    location.reload();
                }
            }
        });
    }, 3000);
}

{% if refresh_running %}
pollStatus();
{% endif %}

// Charts
{% if pred_counts_json %}
(function() {
    var predCounts = JSON.parse('{{ pred_counts_json|escapejs }}');
    var leagueLabels = JSON.parse('{{ league_labels_json|escapejs }}');
    var leagueValues = JSON.parse('{{ league_values_json|escapejs }}');
    var avgValLabels = JSON.parse('{{ avg_val_labels_json|escapejs }}');
    var avgValValues = JSON.parse('{{ avg_val_values_json|escapejs }}');

    Chart.defaults.global.defaultFontColor = 'rgba(255,255,255,0.7)';

    // Prediction Breakdown - Doughnut
    var ctx1 = document.getElementById('predBreakdownChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: ['Home', 'Draw', 'Away'],
            datasets: [{
                data: [predCounts['H'] || 0, predCounts['D'] || 0, predCounts['A'] || 0],
                backgroundColor: ['#1d8cf8', '#ff8d72', '#00f2c3'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { position: 'bottom', labels: { fontColor: 'rgba(255,255,255,0.7)', padding: 12, boxWidth: 12 } },
            cutoutPercentage: 60
        }
    });

    // Predictions per League - Horizontal Bar
    var ctx2 = document.getElementById('leagueCountChart').getContext('2d');
    new Chart(ctx2, {
        type: 'horizontalBar',
        data: {
            labels: leagueLabels,
            datasets: [{
                label: 'Predictions',
                data: leagueValues,
                backgroundColor: 'rgba(29, 140, 248, 0.5)',
                borderColor: '#1d8cf8',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: false },
            scales: {
                xAxes: [{ ticks: { beginAtZero: true, fontColor: 'rgba(255,255,255,0.4)' }, gridLines: { color: 'rgba(255,255,255,0.08)' } }],
                yAxes: [{ ticks: { fontColor: 'rgba(255,255,255,0.7)', fontSize: 10 }, gridLines: { display: false } }]
            }
        }
    });

    // Average Value per League - Bar
    var barColors = avgValValues.map(function(v) { return v > 0 ? 'rgba(0, 242, 195, 0.5)' : 'rgba(253, 93, 147, 0.5)'; });
    var barBorders = avgValValues.map(function(v) { return v > 0 ? '#00f2c3' : '#fd5d93'; });
    var ctx3 = document.getElementById('avgValueChart').getContext('2d');
    new Chart(ctx3, {
        type: 'bar',
        data: {
            labels: avgValLabels,
            datasets: [{
                label: 'Avg Value %',
                data: avgValValues,
                backgroundColor: barColors,
                borderColor: barBorders,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: { display: false },
            scales: {
                xAxes: [{ ticks: { fontColor: 'rgba(255,255,255,0.4)', maxRotation: 45, fontSize: 10 }, gridLines: { display: false } }],
                yAxes: [{ ticks: { fontColor: 'rgba(255,255,255,0.4)', callback: function(v) { return v + '%'; } }, gridLines: { color: 'rgba(255,255,255,0.08)' } }]
            }
        }
    });
})();
{% endif %}
</script>
<style>
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock javascripts %}
